server {
    listen 7126;
    server_name _;

    # Optional Basic Auth (recommended if this port is reachable beyond your trusted LAN)
    # After creating /etc/nginx/.htpasswd, uncomment the next two lines:
    # auth_basic "Moonraker Read-Only";
    # auth_basic_user_file /etc/nginx/.htpasswd;

    # Upstream Moonraker
    set $moonraker_upstream http://127.0.0.1:7125;

    # Common proxy headers
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

    # Hard block any non-GET/HEAD methods (even for allowlisted endpoints)
    if ($request_method !~ ^(GET|HEAD)$) { return 405; }

    # Default deny
    # MobileRaker MJPEG stream (proxied to local MJPEG server)
    location = /stream.mjpg {
        proxy_pass http://127.0.0.1:8081/stream.mjpg;
	proxy_method GET;
        proxy_http_version 1.1;
        proxy_buffering off;
        proxy_read_timeout 3600s;
        add_header Cache-Control "no-cache" always;
    }

    # Single-frame snapshot endpoint (used by Prusa Connect, optional for clients)
    location = /snapshot.jpg {
        proxy_pass http://127.0.0.1:8081/snapshot.jpg;
	proxy_method GET;
        proxy_http_version 1.1;
        proxy_buffering off;
        proxy_read_timeout 10s;
        add_header Cache-Control "no-cache" always;
    }

    location / { return 404; }


    # --- Allowlist: SAFE, READ endpoints ---
    # Basic health/info
    location = /server/info            { proxy_pass $moonraker_upstream; }
    location = /server/config          { proxy_pass $moonraker_upstream; }

    # Printer status queries
    location = /printer/info           { proxy_pass $moonraker_upstream; }
    location = /printer/objects/list   { proxy_pass $moonraker_upstream; }
    location = /printer/objects/query  { proxy_pass $moonraker_upstream; }

    # System info (read-only)
    location = /machine/system_info    { proxy_pass $moonraker_upstream; }

    # WebSocket (used by clients for live status)
    location /websocket {
        auth_basic off;
	proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_pass $moonraker_upstream;
    }
}
