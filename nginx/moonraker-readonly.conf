server {
    listen 7126;
    server_name _;

    # NOTE:
    # Do NOT enable auth_basic on this server.
    # MobileRaker (and other Moonraker clients) do not support
    # HTTP Basic Auth for WebSocket connections.
    # Enabling auth_basic will cause /websocket to return 401
    # and break live status + camera feeds.

    # Upstream Moonraker
    set $moonraker_upstream http://127.0.0.1:7125;

    # Common proxy headers
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

    # Hard block any non-GET/HEAD methods (even for allowlisted endpoints)
    if ($request_method !~ ^(GET|HEAD)$) { return 405; }

    # Default deny
    location / { return 404; }

    # --- Allowlist: SAFE, READ endpoints ---
    location = /server/info            { proxy_pass $moonraker_upstream; }
    location = /server/config          { proxy_pass $moonraker_upstream; }

    location = /printer/info           { proxy_pass $moonraker_upstream; }
    location = /printer/objects/list   { proxy_pass $moonraker_upstream; }
    location = /printer/objects/query  { proxy_pass $moonraker_upstream; }

    location = /machine/system_info    { proxy_pass $moonraker_upstream; }

    # WebSocket (used by clients for live status)
    location /websocket {
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_pass $moonraker_upstream;
    }
}
